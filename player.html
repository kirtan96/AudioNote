<!DOCTYPE HTML>
<head>
  
  <link rel="stylesheet" type="text/css" href="player.css">
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.1/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js"></script>
  

<script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBBmvxKIyXz_SnNqKIQljm2kbl1AeZZgrE",
      authDomain: "audio-note-pro.firebaseapp.com",
      databaseURL: "https://audio-note-pro.firebaseio.com",
      storageBucket: "audio-note-pro.appspot.com",
      messagingSenderId: "1014839766664"
    };
    firebase.initializeApp(config);

    firebase.auth().onAuthStateChanged(u => {
      if (u) {
        user = u;
        userId = u.uid;
        firebase.database().ref('/users/' + userId).once('value').then(function(snapshot) {
          var name = snapshot.val().name;
          if(snapshot.val().allFiles){
            var files = snapshot.val().allFiles;
            allFiles = files.split("||");
          }
          $("#listOfFiles").empty();
          $("#welcome").text(name);
          allFiles.forEach(function(elem){
            if(elem!==''){
              $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
            }
          });
        });
      } else {
        window.location.href = 'index.html';
      }
    });
</script>


  <h1>Audio Note</h1>
  <button id="SignoutButton">Sign out</button>
  <p id="welcome" style="margin-top:15px;"></p>
  <button id="backButton" onclick=goBack()>Back</button>
</head>

<body>

<div class="searchBar">
  
    <input id="search" style="margin-left:10px;" placeholder="Search" onkeyup=liveSearch()>
    <button id="searchButton">Search</button>
    <input type="checkbox" id="checkbox"> Live Search</input>
    
</div>

<div class="li" style="margin-top:80px;float:left;width:100%">
  <ul id="listOfFiles"></ul>
</div>

<div class="player" style="margin-top:100px;">
  <center>
    <h1 id="title" style="color:#5992DC;margin-bottom:10px;"></h1>
    <audio id="audio" style="width:75%;min-width:300px;" controls>
      <source id="mp3Source" type="audio/mp3" src=""></source>
    </audio>
  </center>
</div>
</body>

<script>
    $("#backButton").hide();
    $(".player").hide();
    var user = firebase.auth().currentUser;
    var userId;
    var SignoutButton = $("#SignoutButton");
    var allFiles = [];

    // Get the modal
    var modal = document.getElementById('myModal');
    var span = $(".close");

    var database = firebase.database();

    var audio = document.getElementById('audio');
    var source = document.getElementById('mp3Source');
    
    SignoutButton.click(function(){
      firebase.auth().signOut();
      window.location.href = 'index.html';
    });

    function valid(file){
      if(file.length === 0){
        return false;
      }
      return !allFiles.includes(file);
    }

    function getAllFiles(){
      var a = "";
      allFiles.forEach(function(elem){
        if(elem !== ''){
          a+=elem+"||";
        }
      });
      return a;
    }

    $("#file").click(function(){
      console.log($("#file").val());
    });
    
    $("#searchButton").click(function(){
      var s = $("#search").val();
      if(s.trim()!==''){
        searchForFile(s);
      }
      else{
        $("#listOfFiles").empty();
        loadListView();
      }
    });

    function searchForFile(file){
      $("#listOfFiles").empty();
      allFiles.forEach(function(elem){
        if(elem.includes(file)){
          $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
        }
      });
    }

    function liveSearch(){
      var s = $("#search").val();
      if(document.getElementById("checkbox").checked)
      {
        if(s.trim()!==''){
          searchForFile(s);
        }
        else{
          loadListView();
        }
      }
    }

    function loadListView(){
      $("#listOfFiles").empty();
          allFiles.forEach(function(elem){
              if(elem!==''){
                $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
              }
            });
    }

    function playAudio(id){
      $(".li").hide();
      $(".searchBar").hide();
      $("#backButton").show();
      $(".player").show();
      $("#title").text(id);
      setAudio(id);
    }

    function setAudio(id){
      firebase.database().ref('/users/' + userId + '/audioFiles/'+id).once('value').then(function(snapshot) {
          var url = snapshot.val().audioURL;
          source.src=url;
          audio.load(); //call this to just preload the audio without playing
          audio.play();
      });
    }

    function goBack(){
      $(".li").show();
      $(".searchBar").show();
      $("#backButton").hide();
      $(".player").hide();
      audio.pause();
    }
    // When the user clicks the button, open the modal
    /*btn.onclick = function() {
      console.log("button clicked");
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.click(function() {
      modal.style.display = "none";
    });

    add.click(function() {
      modal.style.display = "none";
        
    });

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
          modal.style.display = "none";
      }
    }*/
  </script>


