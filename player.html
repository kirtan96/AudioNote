<!DOCTYPE HTML>
<head>
  
  <link rel="stylesheet" type="text/css" href="player.css">
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.1/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js"></script>
  

<script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBBmvxKIyXz_SnNqKIQljm2kbl1AeZZgrE",
      authDomain: "audio-note-pro.firebaseapp.com",
      databaseURL: "https://audio-note-pro.firebaseio.com",
      storageBucket: "audio-note-pro.appspot.com",
      messagingSenderId: "1014839766664"
    };
    firebase.initializeApp(config);

    firebase.auth().onAuthStateChanged(u => {
      if (u) {
        user = u;
        userId = u.uid;
        firebase.database().ref('/users/' + userId).once('value').then(function(snapshot) {
          var name = snapshot.val().name;
          if(snapshot.val().allFiles){
            var files = snapshot.val().allFiles;
            allFiles = files.split("||");
          }
          $("#listOfFiles").empty();
          $("#welcome").text(name);
          allFiles.forEach(function(elem){
            if(elem!==''){
              $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
            }
          });
        });
      } else {
        window.location.href = 'index.html';
      }
    });
</script>


  <h1>Audio Note</h1>
  <button id="SignoutButton">Sign out</button>
  <p id="welcome" style="margin-top:15px;"></p>
  <button id="backButton" onclick=goBack()>Back</button>
</head>

<body>

<div class="searchBar">
  <input id="search" style="margin-left:10px;display:inline-block;" placeholder="Search" onkeyup=liveSearch()>
  <p id="noResultFound" style="margin:10px;color:red;display:inline-block;">No Result Found</p>
</div>

<div class="menu">
  <button id="newFile" onclick=createFile()>New File</button>
  <button id="deleteFile" style="color:red;" onclick=deleteFile()>Delete File</button>
</div>

<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">×</span>
    <input type="file" name="myfile" accept="audio/mp3" id="fileChooser" style="margin-bottom:5px;"></input>
    <br>
    <input id="fileName" placeholder="File name" type="text" style="margin-bottom:5px;">
    <button id="uploadButton" style="margin-bottom:5px;">Upload</button>
    <p id="fae">Invalid File name or a File with this name already exists.</p>
    <br>
    <progress value="0" max="100" id="uploader">0%</progress>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close">×</span>
    <select id="selector" style="width:25%;min-width:150px;"></select>
    <button id="deleteButton" style="color:red;" onclick=deleteAlert()>Delete</button>
    <center>
      <div id="confirmation">
        <h4 id="confText" style="margin-top:15px;margin-bottom:5px;">Are you sure?</h4>
        <button id="yes">Yes</button>
        <button id="no">No</button>
      </div>
    </center>
  </div>
</div>

<div class="li">
  <ul id="listOfFiles"></ul>
</div>

<div class="player" style="margin-top:100px;">
  <center>
    <h1 id="title" style="color:#5992DC;margin-bottom:10px;"></h1>
    <audio id="audio" style="width:75%;min-width:300px;margin-bottom:10px;" controls>
      <source id="mp3Source" type="audio/mp3" src=""></source>
    </audio>
  </center>
  <ul id="noteList" style="width: 80%; height: 365px; overflow: auto; margin:5px auto;border:2px solid #5992DC;border-radius:10px;">
  </ul>
  <div class="noteAdder">
    <p class="time" id="timer" style="padding:10px;width:50px;height:15px;margin-right:5px;display:inline-block;vertical-align: middle;text-align:center;"></p>
    <textarea id="noteInput" onkeyup=pauseAudio()></textarea>
    <button id="addNote" onclick=addNote()>Add</button>
  </div>
</div>
</body>

<script>
    $("#backButton").hide();
    $(".player").hide();
    var user = firebase.auth().currentUser;
    var userId;
    var SignoutButton = $("#SignoutButton");
    var allFiles = [];
    var map = {};
    var uploading = false;

    // Get the modal
    var modal = document.getElementById('myModal');
    var deleteModal = document.getElementById('deleteModal');
    var span = $(".close");

    var database = firebase.database();

    var audio = document.getElementById('audio');
    var source = document.getElementById('mp3Source');


    var fileButton = $("#fileChooser");
    var fileInput = $("#fileName");
    var uploadButton = $("#uploadButton");
    var uploader = $("#uploader");
    var fae = $("#fae");
    fae.hide();
    $("#noResultFound").hide();

    fileButton.change(function(e){
      var file = e.target.files[e.target.files.length-1];
      fileInput.val(file.name.replace(".mp3", "").trim());
      uploadButton.click(function(){
        fae.hide();
        if(valid(fileInput.val().trim())){
          uploading = true;
          var storageRef = firebase.storage().ref(userId+"/"+ fileInput.val().trim());
          var task = storageRef.put(file);
          task.on('state_changed', function progress(snapshot){
            var percentage = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
            uploader.val(percentage);
          },
          function error(err){

          },
          function complete(){
            if(valid(fileInput.val().trim()))
            {
              allFiles.push(fileInput.val().trim());
              var adaNameRef = firebase.database().ref('users/' + userId + '');
              adaNameRef.child('allFiles').set(getAllFiles());
              uploader.val(0);
              fileButton.val(null);
              storageRef.getDownloadURL().then(function(url) {
                var nameRef = firebase.database().ref('users/' + userId + '/audioFiles/'+fileInput.val());
                nameRef.child('audioURL').set(url);
                fileInput.val("");
                modal.style.display = "none";
                loadListView();
                uploading = false;
              });
            }
          });
        }
        else
        {
          fae.show();
        }
      });
    });


    function valid(file){
      if(file.length === 0){
        return false;
      }
      return !allFiles.includes(file);
    }

    
    SignoutButton.click(function(){
      firebase.auth().signOut();
      window.location.href = 'index.html';
    });

    function valid(file){
      if(file.length === 0){
        return false;
      }
      return !allFiles.includes(file);
    }

    function getAllFiles(){
      var a = "";
      allFiles.forEach(function(elem){
        if(elem !== ''){
          a+=elem+"||";
        }
      });
      return a;
    }

    $("#file").click(function(){
      console.log($("#file").val());
    });

    function searchForFile(file){
      $("#listOfFiles").empty();
      $("#noResultFound").hide();
      if(!file.includes("|")){
        allFiles.forEach(function(elem){
          var x = "";
          firebase.database().ref('/users/' + userId + '/audioFiles/'+elem).once('value').then(function(snapshot) {
            var ns = snapshot.val().notes;
            if(ns!==undefined){
              getNotesFromDB(ns);
              x = getAllNotes();
              if(elem.includes(file) || x.includes(file)){
                $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
              }
            }
          });
        });
      }
      else{
        $("#noResultFound").hide();
      }
    }

    function liveSearch(){
      var s = $("#search").val();
      if(s.trim()!==''){
        $("#noResultFound").hide();
        searchForFile(s);
      }
      else{
        $("#noResultFound").hide();
        loadListView();
      }
    }

    function loadListView(){
      $("#listOfFiles").empty();
          allFiles.forEach(function(elem){
              if(elem!==''){
                $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
              }
            });
    }

    function playAudio(id){
      $(".li").hide();
      $(".searchBar").hide();
      $(".menu").hide();
      $("#backButton").show();
      $(".player").show();
      $("#title").text(id);
      map={};
      $("#noteList").empty();
      setAudio(id);
    }

    function setAudio(id){
      firebase.database().ref('/users/' + userId + '/audioFiles/'+id).once('value').then(function(snapshot) {
          var url = snapshot.val().audioURL;
          var ns = snapshot.val().notes;
          if(ns!==undefined){
            getNotesFromDB(ns);
            loadNoteListView();
          }
          source.src=url;
          audio.load(); //call this to just preload the audio without playing
          audio.play();

      });
    }

    function goBack(){
      $(".li").show();
      $(".searchBar").show();
      $(".menu").show();
      $("#backButton").hide();
      $(".player").hide();
      audio.pause();
      map = {};
    }

    function createFile(){
      modal.style.display = "block";
    }

    function deleteFile(){
      deleteModal.style.display = "block";
      $("#confirmation").hide();
      $("#selector").empty();
      allFiles.forEach(function(elem){
        if(elem!==''){
          var opt = document.createElement('option');
          opt.text = elem;
          document.getElementById("selector").appendChild(opt);
        }
      });
    }

    function deleteAlert(){
      var i = document.getElementById("selector").selectedIndex;
      var temp = allFiles[i];
      if(temp!= undefined){
        $("#confirmation").show();
        
        $("#confText").text(temp + " will be deleted. Are you sure?");
        $("#no").click(function(){
          $("#confirmation").hide();
        });
        $("#yes").click(function(){
          var storage = firebase.storage();
          var storageRef = storage.ref();
          var desertRef = storageRef.child(userId + '/' + temp);
          desertRef.delete().then(function() {
            console.log("delete successful");
            allFiles = remove(temp);
            loadListView();
            var adaNameRef = firebase.database().ref('users/' + userId + '');
            adaNameRef.child('allFiles').set(getAllFiles());
            firebase.database().ref('users/' + userId + "/audioFiles/" + temp).remove();
            deleteModal.style.display = "none";
          }).catch(function(error) {
            console.log("Uh-oh, an error occurred: " + error);
          });
        });
      }
    }

    function addNote(){
      var s = $("#noteInput").val().trim();
      if(s !== ''){
        if(map[$("#timer").text()]==undefined){
          map[$("#timer").text()] = s;
        }
        else{
          map[$("#timer").text()] = map[$("#timer").text()] + "\n" +  s;
        }
        loadNoteListView();
        var nameRef = firebase.database().ref('users/' + userId + '/audioFiles/'+ $("#title").text());
        nameRef.child('notes').set(getAllNotes());
        $("#noteInput").val("");
        $("#timer").text("");
        audio.play();
      }
    }

    function getAllNotes(){
      var x = "";
      for(var key in map){
        if(key!==""){
          x += key + "|||" + map[key] + "|||||";
        }
      }
      return x;
    }

    function getNotesFromDB(id){
      map = {};
      var a = id.split("|||||");
      for(var n in a){
        if(a[n]!== ''){
          var z = a[n].split("|||");
          map[z[0]] = z[1];
        }
      }
    }

    function loadNoteListView(){
      $("#noteList").empty();
      sortMap();
      for(var key in map){
        if(key!==''){
          $("#noteList").append("<li><div class='notes'><div style='display:inline-block;width:50px;height:100%;background-color:#5992DC;padding:10px;margin-right:5px;'><p id='" + key + "' onclick=goTo(this.id) class='time' style='cursor:pointer;'>" + key + "</p></div><p id='" + key + "' onclick=goTo(this.id) class='note' style='cursor:pointer;'>" + map[key] + "</p><button id='" + key + "' class='delete' onclick=deleteNote(this.id) style='float:right;'>Delete</button><button class='edit' style='float:right;'>Edit</button></div></li>");
        }
      }
    } 

    function sortMap(){
      var keys = Object.keys(map),i, len = keys.length;
      keys.sort();
      var x = {};
      for (i = 0; i < len; i++) {
        x[keys[i]] = map[keys[i]];
      }
      map = x;
    }  

    //id = 04:40
    function goTo(id){
      var elem = id.split(":");
      var minute = Number(elem[0]) * 60;
      var second = Number(elem[1]); 
      audio.currentTime = minute + second;
    }

    function deleteNote(id){
      delete map[id];
      var nameRef = firebase.database().ref('users/' + userId + '/audioFiles/'+ $("#title").text());
      nameRef.child('notes').set(getAllNotes());
      loadNoteListView();
    }

    function pauseAudio(){
      if($("#noteInput").val() !== ""){
        audio.pause();
        var time = audio.currentTime;
        var min = (time/60)|0;
        var sec = (time%60)|0;
        var m = min + "";
        var s = sec + "";
        if(min < 10){
          m = "0" + m;
        }
        if(sec < 10){
          s = "0" + s;
        }
        $("#timer").text(m + ":" + s);
      }
      else
      {
        audio.play();
        $("#timer").text("");
      }
    } 

    function remove(x){
      var a = [];
      allFiles.forEach(function(elem){
        if(elem!== '' && elem!==x){
          a.push(elem);
        }
      });
      return a;
    }

    // When the user clicks on <span> (x), close the modal
    span.click(function() {
      modal.style.display = "none";
      deleteModal.style.display = "none";
    });

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal || event.target==deleteModal) {
          if(!uploading){
            modal.style.display = "none";
          }
          deleteModal.style.display = "none";
      }

    }
  </script>


