<!DOCTYPE HTML>
<head>
  
  <link rel="stylesheet" type="text/css" href="player.css">
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.1/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js"></script>
  

<script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBBmvxKIyXz_SnNqKIQljm2kbl1AeZZgrE",
      authDomain: "audio-note-pro.firebaseapp.com",
      databaseURL: "https://audio-note-pro.firebaseio.com",
      storageBucket: "audio-note-pro.appspot.com",
      messagingSenderId: "1014839766664"
    };
    firebase.initializeApp(config);

    firebase.auth().onAuthStateChanged(u => {
      if (u) {
        user = u;
        userId = u.uid;
        firebase.database().ref('/users/' + userId).once('value').then(function(snapshot) {
          var name = snapshot.val().name;
          if(snapshot.val().allFiles){
            var files = snapshot.val().allFiles;
            allFiles = files.split("||");
          }
          $("#listOfFiles").empty();
          $("#welcome").text(name);
          allFiles.forEach(function(elem){
            if(elem!==''){
              $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
            }
          });
        });
      } else {
        window.location.href = 'index.html';
      }
    });
</script>


  <h1>Audio Note</h1>
  <button id="SignoutButton">Sign out</button>
  <p id="welcome" style="margin-top:15px;"></p>
  <button id="backButton" onclick=goBack()>Back</button>
</head>

<body>

<div class="searchBar">
  <input id="search" style="margin-left:10px;" placeholder="Search" onkeyup=liveSearch()>
</div>

<div class="menu">
  <button id="newFile" onclick=createFile()>New File</button>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close">Ã—</span>
      <input type="file" name="myfile" accept="audio/mp3" id="fileChooser" style="margin-bottom:5px;"></input>
      <br>
      <input id="fileName" placeholder="File name" type="text" style="margin-bottom:5px;">
    <button id="uploadButton" style="margin-bottom:5px;">Upload</button>
    <p id="fae">Invalid File name or a File with this name already exists.</p>
    <br>
    <progress value="0" max="100" id="uploader">0%</progress>
    </div>
  </div>

<div class="li" style="float:left;width:100%">
  <ul id="listOfFiles"></ul>
</div>

<div class="player" style="margin-top:100px;">
  <center>
    <h1 id="title" style="color:#5992DC;margin-bottom:10px;"></h1>
    <audio id="audio" style="width:75%;min-width:300px;" controls>
      <source id="mp3Source" type="audio/mp3" src=""></source>
    </audio>
  </center>
</div>
</body>

<script>
    $("#backButton").hide();
    $(".player").hide();
    var user = firebase.auth().currentUser;
    var userId;
    var SignoutButton = $("#SignoutButton");
    var allFiles = [];
    var uploading = false;

    // Get the modal
    var modal = document.getElementById('myModal');
    var span = $(".close");

    var database = firebase.database();

    var audio = document.getElementById('audio');
    var source = document.getElementById('mp3Source');


    var fileButton = $("#fileChooser");
    var fileInput = $("#fileName");
    var uploadButton = $("#uploadButton");
    var uploader = $("#uploader");
    var fae = $("#fae");
    fae.hide();

    fileButton.change(function(e){
      var file = e.target.files[e.target.files.length-1];
      fileInput.val(file.name.replace(".mp3", "").trim());
      uploadButton.click(function(){
        fae.hide();
        if(valid(fileInput.val().trim())){
          uploading = true;
          var storageRef = firebase.storage().ref(userId+"/"+ fileInput.val().trim());
          var task = storageRef.put(file);
          task.on('state_changed', function progress(snapshot){
            var percentage = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
            uploader.val(percentage);
          },
          function error(err){

          },
          function complete(){
            allFiles.push(fileInput.val().trim());
            var adaNameRef = firebase.database().ref('users/' + userId + '');
            adaNameRef.child('allFiles').set(getAllFiles());
            uploader.val(0);
            fileButton.val(null);
            storageRef.getDownloadURL().then(function(url) {
              var adaNameRef = firebase.database().ref('users/' + userId + '/audioFiles/'+fileInput.val());
              adaNameRef.child('audioURL').set(url);
              fileInput.val("");
              modal.style.display = "none";
              loadListView();
              uploading = false;
            });
          });
        }
        else
        {
          fae.show();
        }
      });
    });


    function valid(file){
      if(file.length === 0){
        return false;
      }
      return !allFiles.includes(file);
    }

    
    SignoutButton.click(function(){
      firebase.auth().signOut();
      window.location.href = 'index.html';
    });

    function valid(file){
      if(file.length === 0){
        return false;
      }
      return !allFiles.includes(file);
    }

    function getAllFiles(){
      var a = "";
      allFiles.forEach(function(elem){
        if(elem !== ''){
          a+=elem+"||";
        }
      });
      return a;
    }

    $("#file").click(function(){
      console.log($("#file").val());
    });

    function searchForFile(file){
      $("#listOfFiles").empty();
      allFiles.forEach(function(elem){
        if(elem.includes(file)){
          $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
        }
      });
    }

    function liveSearch(){
      var s = $("#search").val();
      if(s.trim()!==''){
        searchForFile(s);
      }
      else{
        loadListView();
      }
    }

    function loadListView(){
      $("#listOfFiles").empty();
          allFiles.forEach(function(elem){
              if(elem!==''){
                $("#listOfFiles").append("<li id='" + elem + "' onclick=playAudio(this.id)><div id='list'><a><img src='mp3.png' style='border:5px solid #6EBDB7;'/></a><center><h4 id='center'>" + elem + "</h4></center></div></li>");
              }
            });
    }

    function playAudio(id){
      $(".li").hide();
      $(".searchBar").hide();
      $(".menu").hide();
      $("#backButton").show();
      $(".player").show();
      $("#title").text(id);
      setAudio(id);
    }

    function setAudio(id){
      firebase.database().ref('/users/' + userId + '/audioFiles/'+id).once('value').then(function(snapshot) {
          var url = snapshot.val().audioURL;
          source.src=url;
          audio.load(); //call this to just preload the audio without playing
          audio.play();
      });
    }

    function goBack(){
      $(".li").show();
      $(".searchBar").show();
      $(".menu").show();
      $("#backButton").hide();
      $(".player").hide();
      audio.pause();
    }

    function createFile(){
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.click(function() {
      modal.style.display = "none";
    });

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal && !uploadings) {
          console.log("came in here as well");
          modal.style.display = "none";
      }
    }
  </script>


